<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 40px;
            margin-top: -30px;
            position: relative;
            z-index: 1;
        }
        .card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            color: #333;
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }
        .btn-primary {
            background: #667eea;
            color: #fff;
            border: 2px solid #667eea;
            border-radius: 30px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #5a67d8;
            border-color: #5a67d8;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            border: none;
            border-radius: 30px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .btn-outline-primary {
            color: #667eea;
            border-color: #667eea;
            border-radius: 30px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            border-color: #667eea;
        }
        .form-control, .form-select {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 10px;
            padding: 10px 15px;
        }
        .form-control:focus, .form-select:focus {
            background: #f8f9fa;
            color: #333;
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        #resultCanvas {
            border-radius: 15px;
            border: 1px solid #e9ecef;
            max-width: 100%;
            height: auto;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .alert-dark {
            background: #343a40;
            color: #fff;
        }
        h1 {
            color: #fff;
        }
        h5 {
            color: #333;
            font-weight: 600;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
        }
        .file-input-label:hover {
            border-color: #5a67d8;
            background: #e9ecef;
        }
        .file-input-label i {
            margin-right: 15px;
            color: #667eea;
            font-size: 1.5rem;
        }
        .file-input-label span {
            font-weight: 500;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .border-primary {
            border: 3px solid #667eea !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#">
                <i class="fas fa-brain me-2"></i>AI Detection API
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="index.html">
                    <i class="fas fa-search me-1"></i>YOLO Detection
                </a>
                <a class="nav-link" href="paddlet.html">
                    <i class="fas fa-font me-1"></i>PaddleOCR
                </a>
            </div>
        </div>
    </nav>

    <div class="hero-section text-center py-5 bg-light">
        <h1 class="display-4 fw-bold mb-3"><i class="fas fa-brain text-primary"></i> YOLOv8 Object Detection</h1>
        <p class="lead text-muted mb-4">Upload models, detect objects in images with advanced AI</p>
    </div>

    <div class="container">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-upload text-primary"></i> Upload Model</h5>
                        <div class="file-input-wrapper mb-3">
                            <input type="file" id="modelFile" accept=".pt,.onnx">
                            <label for="modelFile" class="file-input-label">
                                <i class="fas fa-file-upload"></i>
                                <span>Choose Model File (.pt or .onnx)</span>
                            </label>
                        </div>
                        <button class="btn btn-primary w-100" onclick="uploadModel()">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Model
                        </button>
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-list text-success"></i> Select Model</h5>
                        <select id="modelSelect" class="form-select mb-3">
                            <option value="">Select a model...</option>
                        </select>
                        <button class="btn btn-outline-primary w-100" onclick="loadModels()">
                            <i class="fas fa-sync"></i> Refresh Models
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-search text-warning"></i> Detect Objects</h5>
                        <p class="text-muted small">Select an image from samples below and click detect.</p>
                        <button class="btn btn-success w-100" onclick="detectSelected()">
                            <i class="fas fa-search"></i> Detect Selected Image
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-images text-info"></i> Samples from Test Set</h5>
                        <div class="file-input-wrapper mb-3 d-inline-block">
                            <input type="file" id="sampleFile" accept="image/*" multiple>
                            <label for="sampleFile" class="file-input-label">
                                <i class="fas fa-plus"></i>
                                <span>Add Sample Images</span>
                            </label>
                        </div>
                        <div id="samplesGrid" class="row g-3 mt-3">
                            <!-- Sample images will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-chart-bar text-info"></i> Results</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="resultCanvas" class="img-fluid rounded shadow"></canvas>
                            </div>
                            <div class="col-md-6">
                                <div id="detectionsText" class="alert alert-dark" style="white-space: pre-wrap; font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedImageFile = null;

        async function uploadModel() {
            const fileInput = document.getElementById('modelFile');
            const status = document.getElementById('uploadStatus');
            if (!fileInput.files[0]) {
                status.innerHTML = '<div class="alert alert-warning">Please select a model file.</div>';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            status.innerHTML = '<div class="alert alert-info">Uploading...</div>';
            try {
                const response = await fetch('/upload-model', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                status.innerHTML = `<div class="alert alert-success">Model uploaded successfully! ID: <strong>${result.model_id}</strong></div>`;
                loadModels();
            } catch (error) {
                status.innerHTML = '<div class="alert alert-danger">Error uploading model.</div>';
            }
        }

        async function loadModels() {
            try {
                const response = await fetch('/models');
                const result = await response.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">Select a model...</option>';
                result.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_id;
                    option.textContent = `${model.filename}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading models.');
            }
        }

        function addSampleImage(file) {
            const grid = document.getElementById('samplesGrid');
            const col = document.createElement('div');
            col.className = 'col-md-3 col-sm-6';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'img-fluid rounded shadow-sm cursor-pointer';
            img.style.height = '150px';
            img.style.objectFit = 'cover';
            img.onclick = () => selectImage(file, img);
            col.appendChild(img);
            grid.appendChild(col);
            
            // Auto-select the first image if none selected
            if (!selectedImageFile) {
                selectImage(file, img);
            }
        }

        function selectImage(file, imgElement) {
            // Remove selection from all images
            document.querySelectorAll('#samplesGrid img').forEach(img => img.classList.remove('border', 'border-primary'));
            // Add selection to clicked image
            imgElement.classList.add('border', 'border-primary');
            selectedImageFile = file;
        }

        async function detectSelected() {
            const modelSelect = document.getElementById('modelSelect');
            const detectionsText = document.getElementById('detectionsText');
            if (!modelSelect.value) {
                detectionsText.innerHTML = '<div class="alert alert-warning">Please select a model first.</div>';
                return;
            }
            if (!selectedImageFile) {
                detectionsText.innerHTML = '<div class="alert alert-warning">Please select an image from samples.</div>';
                return;
            }
            const formData = new FormData();
            formData.append('file', selectedImageFile);
            detectionsText.innerHTML = '<div class="alert alert-info">Detecting...</div>';
            try {
                const response = await fetch(`/detect/${modelSelect.value}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                detectionsText.innerHTML = `<pre class="mb-0">${JSON.stringify(result, null, 2)}</pre>`;
                drawResults(selectedImageFile, result.detections);
            } catch (error) {
                detectionsText.innerHTML = '<div class="alert alert-danger">Error detecting objects.</div>';
            }
        }

        function drawResults(imageFile, detections) {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                detections.forEach(det => {
                    const [x1, y1, x2, y2] = det.bbox[0];
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(x1, y1 - 30, ctx.measureText(`${det.class_name} ${det.confidence.toFixed(2)}`).width + 20, 30);
                    ctx.fillStyle = '#fff';
                    ctx.font = '18px Inter, Arial';
                    ctx.fillText(`${det.class_name} ${det.confidence.toFixed(2)}`, x1 + 10, y1 - 8);
                });
            };
            img.src = URL.createObjectURL(imageFile);
        }

        // Event listener for sample file input
        document.getElementById('sampleFile').addEventListener('change', (event) => {
            const files = event.target.files;
            for (let file of files) {
                addSampleImage(file);
            }
        });

        // Load models on page load
        loadModels();
    </script>
</body>
</html>